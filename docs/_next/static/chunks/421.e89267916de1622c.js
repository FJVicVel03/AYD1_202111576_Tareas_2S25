"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[421],{3421:function(e,t,a){a.r(t),a.d(t,{default:function(){return j}});var r=a(5893),l=a(7294),o=a(5715),n=a(2013),i=a(269),s=a(4049),c=a(8798),d=a(7262),u=a(4961),h=a(7066);let p=[14.6349,-90.5069],m=[14.609,-90.5269],f=[14.6514,-90.4923],g=[m,[14.6118,-90.5246],[14.6142,-90.5215],[14.6168,-90.5188],[14.6185,-90.516],[14.6196,-90.5128],[14.621,-90.5101],[14.6234,-90.5078],[14.6262,-90.5054],[14.629,-90.5035],[14.6317,-90.5018],[14.6346,-90.5],[14.6375,-90.4986],[14.641,-90.4973],[14.6445,-90.4961],[14.6479,-90.4948],[14.65,-90.4938],f],v=[m,[14.6118,-90.5246],[14.6142,-90.5215],[14.6168,-90.5188],[14.6179,-90.5148],[14.6194,-90.5112],[14.6212,-90.5079],[14.6236,-90.5045],[14.6268,-90.5019],[14.6302,-90.4998],[14.6334,-90.4984],[14.6366,-90.4972],[14.6402,-90.496],[14.6438,-90.4949],[14.6471,-90.4937],f],b={"muy-alta":"#ff5f6d",alta:"#ff9966",media:"#ffd56f",baja:"#8bd46e"},y=[{center:[14.659,-90.486],level:"muy-alta",label:"Zona 18 (simulado)"},{center:[14.645,-90.574],level:"muy-alta",label:"Mixco - Calz. San Juan (simulado)"},{center:[14.611,-90.551],level:"alta",label:"Nudo El Trebol (simulado)"},{center:[14.626,-90.559],level:"alta",label:"Calzada Roosevelt (simulado)"},{center:[14.634,-90.508],level:"alta",label:"Centro/Zona 4-9 (simulado)"},{center:[14.623,-90.532],level:"media",label:"Zona 3 - Mercado (simulado)"},{center:[14.613,-90.535],level:"media",label:"Zona 1 (simulado)"},{center:[14.65,-90.502],level:"media",label:"Carretera a Chinautla (simulado)"},{center:[14.481,-90.587],level:"alta",label:"Villa Nueva - Barcena (simulado)"},{center:[14.603,-90.488],level:"baja",label:"Zona 10 - Reforma (simulado)"},{center:[14.618,-90.505],level:"baja",label:"Zona 9 - Obelisco (simulado)"},{center:[14.644,-90.509],level:"baja",label:"Zona 15 - Vista Hermosa (simulado)"}],x=[{points:[[14.62,-90.53],[14.623,-90.523],[14.617,-90.518],[14.614,-90.525]]}];function M(e,t){let a=(t[0]-e[0])*Math.PI/180,r=(t[1]-e[1])*Math.PI/180;return 12742e3*Math.asin(Math.sqrt(Math.sin(a/2)*Math.sin(a/2)+Math.sin(r/2)*Math.sin(r/2)*Math.cos(e[0]*Math.PI/180)*Math.cos(t[0]*Math.PI/180)))}function k(e,t,a,r){for(let l=0;l<=12;l++){let o=l/12,n=e[0]+(t[0]-e[0])*o,i=e[1]+(t[1]-e[1])*o;for(let e of a)if(M([n,i],e.center)<=e.radius)return!0;for(let e of r)if(function(e,t){let[a,r]=e,l=!1;for(let e=0,o=t.length-1;e<t.length;o=e++){let n=t[e][0],i=t[e][1],s=t[o][0],c=t[o][1];i>r!=c>r&&a<(s-n)*(r-i)/(c-i||1e-12)+n&&(l=!l)}return l}([n,i],e))return!0}return!1}function j(e){let{className:t,showTiles:a=!0,useRouting:j=!0}=e,[w,S]=(0,l.useState)([]),[C,I]=(0,l.useState)(null),[O,z]=(0,l.useState)(!1),[R,E]=(0,l.useState)({distanceMeters:null,durationSec:null,source:"mock",provider:null}),Z=(e,t,a)=>"route:".concat(e[0],",").concat(e[1],"->").concat(t[0],",").concat(t[1],":avoid=").concat(a?1:0),A=(e,t)=>{try{window.localStorage&&localStorage.setItem(e,JSON.stringify({...t,ts:Date.now()}))}catch(e){}},N=e=>{try{if(!window.localStorage)return null;let t=localStorage.getItem(e);if(!t)return null;let a=JSON.parse(t);if(!a||!Array.isArray(a.coords))return null;return a}catch(e){return null}},P=async e=>{try{let t=await fetch("/routes-cache.json",{cache:"no-cache"});if(!t.ok)return null;let a=await t.json(),r=a&&a[e];if(r&&Array.isArray(r.coords))return r;return null}catch(e){return null}},W=(e,t)=>[t,e],_=(0,l.useCallback)(function(e,t,a){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:32,l=[],o=a/111320,n=a/(111320*Math.max(.3,Math.cos(e*Math.PI/180)));for(let a=0;a<=r;a++){let i=a/r*2*Math.PI,s=e+Math.sin(i)*o,c=t+Math.cos(i)*n;l.push([c,s])}return l},[]),J=(0,l.useCallback)(e=>{if(!e||e.length<2)return!1;let t={"muy-alta":550,alta:450,media:350},a=y.filter(e=>"muy-alta"===e.level||"alta"===e.level||"media"===e.level).map(e=>({center:e.center,radius:t[e.level]||300})),r=x.map(e=>e.points);for(let t=0;t<e.length-1;t++)if(k(e[t],e[t+1],a,r))return!0;return!1},[]),D=(0,l.useCallback)(()=>{let e=x.map(e=>[...e.points.map(e=>W(e[0],e[1])),W(e.points[0][0],e.points[0][1])]);if(O){let t={"muy-alta":550,alta:450,media:350};y.forEach(a=>{if("muy-alta"===a.level||"alta"===a.level||"media"===a.level){let[r,l]=a.center,o=_(r,l,t[a.level]);e.push(o)}})}return 0===e.length?null:1===e.length?{type:"Polygon",coordinates:[e[0]]}:{type:"MultiPolygon",coordinates:e.map(e=>[e])}},[O,_]),F=(0,l.useCallback)(e=>{if(!e||e.length<2)return 0;let t=0;for(let a=0;a<e.length-1;a++)t+=M(e[a],e[a+1]);return t},[]),U=(0,l.useCallback)(async()=>{var e,t,a,r,l;if(!j){let e=F(O?v:g);E({distanceMeters:Math.round(e),durationSec:Math.round(e/8.33),source:"mock",provider:null});return}let o=[m[1],m[0]],n=[f[1],f[0]],i=D(),s=Z(o,n,O);try{let r=await h.Z.post("/api/ors-route",{start:o,end:n,avoid_polygons:i||void 0}),l=(null==r?void 0:null===(e=r.data)||void 0===e?void 0:e.coordinates)||[];if(l.length){let e=l.map(e=>[e[1],e[0]]);if(O&&J(e)){S([]),I("Ruta externa intersecta zonas a evitar \xb7 usando alternativa segura");let e=F(v);E({distanceMeters:Math.round(e),durationSec:Math.round(e/8.33),source:"mock",provider:null});return}S(e),I(null);let o=null==r?void 0:null===(t=r.data)||void 0===t?void 0:t.summary,n=(null==r?void 0:null===(a=r.data)||void 0===a?void 0:a.provider)||"ors";A(s,{coords:l,summary:o,provider:n});try{await h.Z.post("/api/save-route-cache",{key:s,coords:l,summary:o,provider:n})}catch(e){}if(o&&(o.distance||o.duration))E({distanceMeters:Math.round(o.distance||0),durationSec:Math.round(o.duration||0),source:"ors",provider:n});else{let t=F(e);E({distanceMeters:Math.round(t),durationSec:Math.round(t/8.33),source:"estimate",provider:n})}return}throw Error("Respuesta del proxy sin coordenadas")}catch(a){console.error("Error obteniendo ruta desde proxy /api/ors-route:",a);let e=N(s)||await P(s);if(e&&Array.isArray(e.coords)&&e.coords.length){let t=e.coords.map(e=>[e[1],e[0]]);if(O&&J(t)){S([]),I("Usando ruta cacheada, pero intersecta zonas \xb7 alternando a ruta segura");let e=F(v);E({distanceMeters:Math.round(e),durationSec:Math.round(e/8.33),source:"mock",provider:null});return}S(t),I("Usando ruta cacheada");let a=e.summary,r=e.provider||"cache";if(a&&(a.distance||a.duration))E({distanceMeters:Math.round(a.distance||0),durationSec:Math.round(a.duration||0),source:"cached",provider:r});else{let e=F(t);E({distanceMeters:Math.round(e),durationSec:Math.round(e/8.33),source:"cached-estimate",provider:r})}return}I((null==a?void 0:null===(l=a.response)||void 0===l?void 0:null===(r=l.data)||void 0===r?void 0:r.error)||(null==a?void 0:a.message)||"Error de ruteo");let t=F(O?v:g);E({distanceMeters:Math.round(t),durationSec:Math.round(t/8.33),source:"mock",provider:null})}},[j,O,D,F]);(0,l.useEffect)(()=>{U()},[U]);let V=(0,l.useMemo)(()=>{let e={"muy-alta":550,alta:450,media:350,baja:250};return y.map(t=>({center:t.center,radius:e[t.level]||300}))},[]),q=(0,l.useMemo)(()=>x.map(e=>e.points),[]),B=w.length?w:O?v:g,H=(0,l.useMemo)(()=>{let e=[];for(let t=0;t<B.length-1;t++){let a=B[t],r=B[t+1];e.push({a,b:r,risky:k(a,r,V,q)})}return e},[V,q,B]),T=H.some(e=>e.risky);return(0,r.jsxs)("div",{className:t,style:{width:"100%",height:"100%"},children:[(0,r.jsxs)(o.h,{center:p,zoom:13,style:{width:"100%",height:"100%",background:"#eef3f8"},zoomControl:!0,scrollWheelZoom:!0,children:[a&&(0,r.jsx)(n.I,{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:"\xa9 <a href='https://www.openstreetmap.org/copyright'>OpenStreetMap</a> contributors"}),y.map((e,t)=>{let a=b[e.level]||"#ff9966",l="muy-alta"===e.level?550:"alta"===e.level?450:"media"===e.level?350:250,o="muy-alta"===e.level?.28:"alta"===e.level?.24:"media"===e.level?.22:.18;return(0,r.jsx)(i.C,{center:e.center,radius:l,pathOptions:{color:a,fillColor:a,fillOpacity:o,weight:2},children:(0,r.jsxs)(s.u,{children:[e.label," â€” Incidencia ",e.level.replace("-"," ")]})},"heat-".concat(t))}),x.map((e,t)=>(0,r.jsx)(c.m,{positions:e.points,pathOptions:{color:"#b91c1c",fillColor:"#ef4444",fillOpacity:.2,dashArray:"6 6"},children:(0,r.jsx)(s.u,{children:"Area de riesgo"})},"hz-p-".concat(t))),H.map((e,t)=>(0,r.jsx)(d.a,{positions:[e.a,e.b],pathOptions:{color:e.risky?"#dc2626":"#2563eb",weight:5,opacity:e.risky?.95:.85}},"seg-".concat(t))),(0,r.jsx)(u.c,{center:m,radius:8,pathOptions:{color:"#16a34a",fillColor:"#16a34a",fillOpacity:1},children:(0,r.jsx)(s.u,{children:"Origen"})}),(0,r.jsx)(u.c,{center:f,radius:8,pathOptions:{color:"#7c3aed",fillColor:"#7c3aed",fillOpacity:1},children:(0,r.jsx)(s.u,{children:"Destino"})})]}),(0,r.jsxs)("div",{style:{position:"absolute",right:12,top:12,zIndex:500,background:"rgba(16,24,40,0.85)",color:"white",padding:"10px 12px",borderRadius:10,boxShadow:"0 6px 18px rgba(0,0,0,0.25)",display:"flex",alignItems:"center",gap:10,fontWeight:600},children:[(0,r.jsx)("button",{onClick:()=>z(e=>!e),style:{background:O?"rgba(34,197,94,0.95)":"rgba(30,58,138,0.95)",color:"white",border:"none",borderRadius:8,padding:"6px 10px",cursor:"pointer",fontWeight:700},children:O?"Evitar zonas peligrosas: ON":"Evitar zonas peligrosas"}),(0,r.jsx)("span",{style:{opacity:.9},children:null!=R.distanceMeters&&null!=R.durationSec?"".concat((R.distanceMeters/1e3).toFixed(1)," km \xb7 ").concat((R.durationSec/60).toFixed(0)," min"):"---"})]}),T&&(0,r.jsx)("div",{style:{position:"absolute",left:12,bottom:12,zIndex:400,background:"rgba(220,38,38,0.95)",color:"white",padding:"8px 12px",borderRadius:10,boxShadow:"0 6px 18px rgba(0,0,0,0.2)",display:"flex",alignItems:"center",gap:10,fontWeight:600},children:(0,r.jsx)("span",{children:"Riesgo: la ruta se aproxima a zonas peligrosas."})}),C&&(0,r.jsxs)("div",{style:{position:"absolute",right:12,bottom:12,zIndex:400,background:"rgba(30,58,138,0.95)",color:"white",padding:"8px 12px",borderRadius:10,boxShadow:"0 6px 18px rgba(0,0,0,0.2)",display:"flex",alignItems:"center",gap:12,fontWeight:600,pointerEvents:"auto"},children:[(0,r.jsxs)("span",{children:["Ruta simulada \xb7 ",C]}),(0,r.jsx)("button",{onClick:()=>U(),style:{background:"rgba(234, 179, 8, 0.95)",color:"#111827",border:"none",borderRadius:8,padding:"6px 10px",cursor:"pointer",fontWeight:700},children:"Reintentar"})]})]})}}}]);